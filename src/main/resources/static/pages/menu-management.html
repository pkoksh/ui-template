<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>메뉴 관리</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <!-- ibsheet 추가 -->
    <link rel="stylesheet" href="../assets/ibsheet8/sheet/css/default/ibsheet.css">
    <script src="../assets/ibsheet8/sheet/locale/ko.js"></script>
    <script src ="../assets/ibsheet8/sheet/ibsheet.js"></script>
    <!-- ibsheet 추가 끝 -->
    
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <div class="p-6">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-200">메뉴 관리</h3>
            <div class="flex items-center space-x-2">
                <button id="save-all-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2.5 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md">
                    <i class='bx bx-save text-lg'></i>
                    <span class="font-medium">저장</span>
                </button>
                <button id="refresh-btn" class="bg-slate-500 hover:bg-slate-600 text-white px-5 py-2.5 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md">
                    <i class='bx bx-refresh text-lg'></i>
                    <span class="font-medium">조회</span>
                </button>
                <button id="add-menu-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white px-5 py-2.5 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md">
                    <i class='bx bx-plus text-lg'></i>
                    <span class="font-medium">메뉴 추가</span>
                </button>
            </div>
        </div>

        <!-- 검색 필터 -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">메뉴명 검색</label>
                    <input type="text" id="search-title" placeholder="메뉴명을 입력하세요" 
                           class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent dark:bg-gray-700 dark:text-gray-100 transition-all duration-200">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">URL 검색</label>
                    <input type="text" id="search-url" placeholder="URL을 입력하세요" 
                           class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent dark:bg-gray-700 dark:text-gray-100 transition-all duration-200">
                </div>
                <div class="flex items-end space-x-2">
                    <button id="search-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white px-5 py-3 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md flex-1">
                        <i class='bx bx-search text-lg'></i>
                        <span class="font-medium">검색</span>
                    </button>
                    <button id="clear-search-btn" class="bg-gray-400 hover:bg-gray-500 text-white px-5 py-3 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md">
                        <i class='bx bx-x text-lg'></i>
                        <span class="font-medium">초기화</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 메뉴 테이블 -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">제목</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">아이콘</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">URL</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">순서</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">활성화</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">작업</th>
                        </tr>
                    </thead>
                    <tbody id="menu-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- 메뉴 데이터가 여기에 동적으로 추가됩니다 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 로딩 표시 -->
        <div id="loading" class="hidden flex justify-center items-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <span class="ml-3 text-gray-600 dark:text-gray-300">데이터를 불러오는 중...</span>
        </div>
    </div>

    <!-- 메뉴 추가/편집 모달 -->
    <div id="menu-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-6 border border-gray-200 w-96 shadow-xl rounded-2xl bg-white dark:bg-gray-800 dark:border-gray-700">
            <div class="mt-3">
                <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-6" id="modal-title">메뉴 추가</h3>
                <form id="menu-form">
                    <div class="mb-5">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">제목</label>
                        <input type="text" id="menu-title" class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent dark:bg-gray-700 dark:text-gray-100 transition-all duration-200" required>
                    </div>
                    <div class="mb-5">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">아이콘</label>
                        <input type="text" id="menu-icon" class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent dark:bg-gray-700 dark:text-gray-100 transition-all duration-200" placeholder="bx-home">
                    </div>
                    <div class="mb-5">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">URL</label>
                        <input type="text" id="menu-url" class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent dark:bg-gray-700 dark:text-gray-100 transition-all duration-200" placeholder="dashboard">
                    </div>
                    <div class="mb-5">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">순서</label>
                        <input type="number" id="menu-order" class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent dark:bg-gray-700 dark:text-gray-100 transition-all duration-200" min="0">
                    </div>
                    <div class="mb-6">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="menu-active" class="mr-3 w-4 h-4 text-indigo-600 bg-gray-100 border-gray-300 rounded focus:ring-indigo-500 dark:focus:ring-indigo-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                            <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">활성화</span>
                        </label>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-btn" class="px-6 py-3 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-xl hover:bg-gray-300 dark:hover:bg-gray-500 font-medium transition-all duration-200">
                            취소
                        </button>
                        <button type="submit" class="px-6 py-3 bg-indigo-500 text-white rounded-xl hover:bg-indigo-600 font-medium transition-all duration-200 shadow-sm hover:shadow-md">
                            저장
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let menus = [];
        let filteredMenus = [];
        let editingMenuId = null;

        // API 기본 설정
        const API_BASE = '/api/menus';

        // 페이지 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadMenus();
            setupEventListeners();
        });

        // 이벤트 리스너 설정
        function setupEventListeners() {
            document.getElementById('add-menu-btn').addEventListener('click', () => openModal());
            document.getElementById('save-all-btn').addEventListener('click', saveAllMenus);
            document.getElementById('refresh-btn').addEventListener('click', loadMenus);
            document.getElementById('search-btn').addEventListener('click', performSearch);
            document.getElementById('clear-search-btn').addEventListener('click', clearSearch);
            document.getElementById('cancel-btn').addEventListener('click', closeModal);
            document.getElementById('menu-form').addEventListener('submit', handleSubmit);
            
            // 검색 필드에서 엔터키 이벤트
            document.getElementById('search-title').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            document.getElementById('search-url').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            // 모달 외부 클릭 시 닫기
            document.getElementById('menu-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        }

        // 메뉴 데이터 로드
        async function loadMenus() {
            try {
                showLoading();
                const response = await axios.get(API_BASE);
                menus = response.data;
                filteredMenus = [...menus];
                renderMenuTable();
                console.log('메뉴 데이터 로드 완료:', menus);
            } catch (error) {
                console.error('메뉴 데이터 로드 실패:', error);
                showError('메뉴 데이터를 불러올 수 없습니다.');
            } finally {
                hideLoading();
            }
        }

        // 검색 수행
        function performSearch() {
            const titleSearch = document.getElementById('search-title').value.toLowerCase().trim();
            const urlSearch = document.getElementById('search-url').value.toLowerCase().trim();
            
            filteredMenus = menus.filter(menu => {
                const titleMatch = !titleSearch || (menu.title && menu.title.toLowerCase().includes(titleSearch));
                const urlMatch = !urlSearch || (menu.url && menu.url.toLowerCase().includes(urlSearch));
                return titleMatch && urlMatch;
            });
            
            renderMenuTable();
            
            if (filteredMenus.length === 0) {
                showInfo('검색 조건에 맞는 메뉴가 없습니다.');
            } else {
                showSuccess(`${filteredMenus.length}개의 메뉴를 찾았습니다.`);
            }
        }

        // 검색 초기화
        function clearSearch() {
            document.getElementById('search-title').value = '';
            document.getElementById('search-url').value = '';
            filteredMenus = [...menus];
            renderMenuTable();
            showSuccess('검색 조건이 초기화되었습니다.');
        }

        // 전체 메뉴 저장
        async function saveAllMenus() {
            try {
                showLoading();
                
                // 현재 표시된 메뉴들의 순서 업데이트
                const updatePromises = filteredMenus.map((menu, index) => {
                    const updatedMenu = { ...menu, displayOrder: index + 1 };
                    return axios.put(`${API_BASE}/${menu.id}`, updatedMenu);
                });
                
                await Promise.all(updatePromises);
                showSuccess('모든 메뉴가 성공적으로 저장되었습니다.');
                loadMenus();
            } catch (error) {
                console.error('메뉴 저장 실패:', error);
                showError('메뉴 저장에 실패했습니다.');
            } finally {
                hideLoading();
            }
        }

        // 메뉴 테이블 렌더링
        function renderMenuTable() {
            const tbody = document.getElementById('menu-table-body');
            tbody.innerHTML = '';

            if (filteredMenus.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                        <div class="flex flex-col items-center">
                            <i class='bx bx-search text-4xl mb-2'></i>
                            <span>검색 결과가 없습니다.</span>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
                return;
            }

            filteredMenus.forEach(menu => {
                const row = createMenuRow(menu);
                tbody.appendChild(row);
            });
        }

        // 메뉴 행 생성
        function createMenuRow(menu) {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
            
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <i class='bx ${menu.icon || 'bx-circle'} text-gray-500 mr-2'></i>
                        <span class="text-sm font-medium text-gray-900 dark:text-gray-100">${menu.title}</span>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                    <i class='bx ${menu.icon || 'bx-circle'}'></i>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                    ${menu.url || '-'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                    ${menu.displayOrder || 0}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-3 py-1.5 inline-flex text-xs leading-5 font-semibold rounded-full ${
                        menu.isActive ? 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200' : 'bg-rose-100 text-rose-800 dark:bg-rose-900 dark:text-rose-200'
                    }">
                        ${menu.isActive ? '활성' : '비활성'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <div class="flex space-x-2">
                        <button onclick="editMenu(${menu.id})" class="inline-flex items-center justify-center w-8 h-8 text-indigo-600 hover:text-white hover:bg-indigo-600 rounded-lg transition-all duration-200">
                            <i class='bx bx-edit text-lg'></i>
                        </button>
                        <button onclick="deleteMenu(${menu.id})" class="inline-flex items-center justify-center w-8 h-8 text-rose-600 hover:text-white hover:bg-rose-600 rounded-lg transition-all duration-200">
                            <i class='bx bx-trash text-lg'></i>
                        </button>
                    </div>
                </td>
            `;
            
            return tr;
        }

        // 모달 열기
        function openModal(menu = null) {
            editingMenuId = menu ? menu.id : null;
            
            // 폼 초기화
            document.getElementById('menu-form').reset();
            
            if (menu) {
                // 편집 모드
                document.getElementById('modal-title').textContent = '메뉴 편집';
                document.getElementById('menu-title').value = menu.title || '';
                document.getElementById('menu-icon').value = menu.icon || '';
                document.getElementById('menu-url').value = menu.url || '';
                document.getElementById('menu-order').value = menu.displayOrder || 0;
                document.getElementById('menu-active').checked = menu.isActive || false;
            } else {
                // 추가 모드
                document.getElementById('modal-title').textContent = '메뉴 추가';
                document.getElementById('menu-active').checked = true;
            }
            
            document.getElementById('menu-modal').classList.remove('hidden');
        }

        // 모달 닫기
        function closeModal() {
            document.getElementById('menu-modal').classList.add('hidden');
            editingMenuId = null;
        }

        // 폼 제출 처리
        async function handleSubmit(e) {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('menu-title').value,
                icon: document.getElementById('menu-icon').value,
                url: document.getElementById('menu-url').value,
                displayOrder: parseInt(document.getElementById('menu-order').value) || 0,
                isActive: document.getElementById('menu-active').checked
            };
            
            try {
                if (editingMenuId) {
                    // 편집
                    await axios.put(`${API_BASE}/${editingMenuId}`, formData);
                    showSuccess('메뉴가 성공적으로 수정되었습니다.');
                } else {
                    // 추가
                    await axios.post(API_BASE, formData);
                    showSuccess('메뉴가 성공적으로 추가되었습니다.');
                }
                
                closeModal();
                loadMenus();
            } catch (error) {
                console.error('메뉴 저장 실패:', error);
                showError('메뉴 저장에 실패했습니다.');
            }
        }

        // 메뉴 편집
        function editMenu(id) {
            const menu = menus.find(m => m.id === id);
            if (menu) {
                openModal(menu);
            }
        }

        // 메뉴 삭제
        async function deleteMenu(id) {
            const result = await Swal.fire({
                title: '메뉴 삭제',
                text: '정말로 이 메뉴를 삭제하시겠습니까?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#EF4444',
                cancelButtonColor: '#6B7280',
                confirmButtonText: '삭제',
                cancelButtonText: '취소'
            });
            
            if (result.isConfirmed) {
                try {
                    await axios.delete(`${API_BASE}/${id}`);
                    showSuccess('메뉴가 성공적으로 삭제되었습니다.');
                    loadMenus();
                } catch (error) {
                    console.error('메뉴 삭제 실패:', error);
                    showError('메뉴 삭제에 실패했습니다.');
                }
            }
        }

        // UI 헬퍼 함수들
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function showSuccess(message) {
            Swal.fire({
                icon: 'success',
                title: '성공',
                text: message,
                confirmButtonColor: '#3B82F6'
            });
        }

        function showError(message) {
            Swal.fire({
                icon: 'error',
                title: '오류',
                text: message,
                confirmButtonColor: '#3B82F6'
            });
        }

        function showInfo(message) {
            Swal.fire({
                icon: 'info',
                title: '정보',
                text: message,
                confirmButtonColor: '#3B82F6'
            });
        }
    </script>
</body>
</html>
