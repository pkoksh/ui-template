<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.worksystem.mapper.MenuMapper">

    <!-- Result Map 정의 -->
    <resultMap id="MenuResultMap" type="com.worksystem.entity.Menu">
        <id property="id" column="menu_seq"/>
        <result property="menuId" column="menu_id"/>
        <result property="parentId" column="parent_id"/>
        <result property="title" column="title"/>
        <result property="url" column="url"/>
        <result property="icon" column="icon"/>
        <result property="sortOrder" column="sort_order"/>
        <result property="isActive" column="is_active"/>
        <result property="createdAt" column="created_at"/>
        <result property="description" column="description"/>
    </resultMap>

    <!-- 모든 메뉴 조회 (정렬 순서대로) -->
    <select id="findAllByOrderBySortOrderAsc" resultMap="MenuResultMap">
        SELECT * FROM menus ORDER BY sort_order ASC
    </select>

    <!-- 이름 또는 URL로 메뉴 검색 -->
    <select id="findByNameOrUrl" parameterType="map" resultMap="MenuResultMap">
        SELECT * FROM menus 
        WHERE 1 = 1
            <if test="name != null and name != ''">
                AND title LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="url != null and url != ''">
                AND url LIKE CONCAT('%', #{url}, '%')
            </if>
        ORDER BY sort_order ASC 
    </select>


    <!-- 활성화된 메뉴만 조회 (정렬 순서대로) -->
    <select id="findByEnabledTrueOrderBySortOrderAsc" resultMap="MenuResultMap">
        SELECT * FROM menus WHERE is_active = true ORDER BY sort_order ASC
    </select>

    <!-- ID로 메뉴 조회 -->
    <select id="findById" parameterType="long" resultMap="MenuResultMap">
        SELECT * FROM menus WHERE menu_seq = #{id}
    </select>

    <!-- 메뉴 ID로 메뉴 조회 -->
    <select id="findByMenuId" parameterType="string" resultMap="MenuResultMap">
        SELECT * FROM menus WHERE menu_id = #{menuId}
    </select>

    <!-- 메뉴 추가 -->
    <insert id="insert" parameterType="com.worksystem.entity.Menu" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO menus (
            menu_id, 
            parent_id, 
            title, 
            url, 
            icon, 
            sort_order, 
            is_active,
            created_at
        ) VALUES (
            #{menuId}, 
            #{parentId}, 
            #{title}, 
            #{url}, 
            #{icon}, 
            #{sortOrder}, 
            #{isActive},
            #{createdAt}
        )
    </insert>

    <!-- 메뉴 수정 -->
    <update id="update" parameterType="com.worksystem.entity.Menu">
        UPDATE menus SET 
            title = #{title},
            url = #{url},
            icon = #{icon},
            parent_id = #{parentId},
            sort_order = #{sortOrder},
            is_active = #{isActive}
        WHERE menu_seq = #{id}
    </update>

    <!-- 메뉴 삭제 -->
    <delete id="deleteById" parameterType="long">
        DELETE FROM menus WHERE menu_seq = #{id}
    </delete>

    <!-- 사용자 권한에 따른 접근 가능한 메뉴 조회 -->
    <select id="findAccessibleMenusByUserId" parameterType="string" resultMap="MenuResultMap">
        SELECT DISTINCT m.* 
        FROM menus m
        INNER JOIN group_menu_permissions gmp ON m.menu_id = gmp.menu_id
        INNER JOIN user_group_mappings ugm ON gmp.group_id = ugm.group_id
        WHERE ugm.user_id = #{userId}
          AND m.is_active = true
          AND gmp.can_read = true
        ORDER BY m.sort_order ASC
    </select>

    <!-- 특정 메뉴에 대한 사용자 접근 권한 확인 (존재하면 1, 없으면 0 반환) -->
    <select id="checkUserMenuAccess" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM menus m
        INNER JOIN group_menu_permissions gmp ON m.menu_id = gmp.menu_id
        INNER JOIN user_group_mappings ugm ON gmp.group_id = ugm.group_id
        WHERE ugm.user_id = #{userId}
          AND m.menu_id = #{menuId}
          AND m.is_active = true
          AND gmp.can_read = true
        LIMIT 1
    </select>

    <!-- 사용자의 특정 메뉴 권한 상세 조회 -->
    <select id="findMenuPermissionsByUserAndMenu" parameterType="map" resultType="com.worksystem.dto.MenuDTO">
        SELECT 
            m.menu_seq as id,
            m.menu_id as menuId,
            m.parent_id as parentId,
            m.title,
            m.url,
            m.icon,
            m.sort_order as sortOrder,
            m.is_active as isActive,
            MAX(gmp.can_read) as canRead,
            MAX(gmp.can_write) as canWrite,
            MAX(gmp.can_delete) as canDelete
        FROM menus m
        INNER JOIN group_menu_permissions gmp ON m.menu_id = gmp.menu_id
        INNER JOIN user_group_mappings ugm ON gmp.group_id = ugm.group_id
        WHERE ugm.user_id = #{userId}
          AND m.menu_id = #{menuId}
          AND m.is_active = true
        GROUP BY m.menu_seq, m.menu_id, m.parent_id, m.title, m.url, m.icon, m.sort_order, m.is_active
    </select>

</mapper>
