<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{fragments/common :: ibsheet-head}"></th:block>
    <title>메뉴 관리</title>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <div class="p-6 flex flex-col h-full">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-200">메뉴 관리</h3>
            <div class="flex items-center space-x-2">
                <button id="save-all-btn" class="bg-[#2563EB] hover:bg-[#2563EB]/80 text-white px-5 py-2.5 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md">
                    <i class='bx bx-save text-lg'></i>
                    <span class="font-medium">저장</span>
                </button>
                <button id="refresh-btn" class="bg-[#6C757D] hover:bg-[#6C757D]/80 text-white px-5 py-2.5 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md">
                    <i class='bx bx-refresh text-lg'></i>
                    <span class="font-medium">조회</span>
                </button>
                <button id="add-menu-btn" class="bg-[#ADB5BD] hover:bg-[#ADB5BD]/80 text-white px-5 py-2.5 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md">
                    <i class='bx bx-plus text-lg'></i>
                    <span class="font-medium">추가</span>
                </button>
                <button id="del-menu-btn" class="bg-[#ADB5BD] hover:bg-[#ADB5BD]/80 text-white px-5 py-2.5 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md">
                    <i class='bx bx-minus text-lg'></i>
                    <span class="font-medium">삭제</span>
                </button>
            </div>
        </div>

        <!-- 검색 필터 -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">메뉴명 검색</label>
                    <input type="text" id="search-title" placeholder="메뉴명을 입력하세요" 
                           class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent dark:bg-gray-700 dark:text-gray-100 transition-all duration-200">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">URL 검색</label>
                    <input type="text" id="search-url" placeholder="URL을 입력하세요" 
                           class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent dark:bg-gray-700 dark:text-gray-100 transition-all duration-200">
                </div>
            </div>
        </div>

        <!-- IBSheet 그리드 영역 -->
        <div class="h-full">
            <div id="menu-grid" style="height: 100%;"></div>
        </div>

        <!-- 로딩 표시 -->
        <th:block th:replace="~{fragments/common :: loading-spinner}"></th:block>
    </div>

    <!-- 페이지별 스크립트 -->
    <script>
        let menuGrid = null; // IBSheet 그리드 객체

        // API 기본 설정
        const API_BASE = '/api/menus';

        // 페이지 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initGrid();
            loadMenus();
            setupEventListeners();
        });

        // IBSheet 그리드 초기화
        function initGrid() {
            const gridConfig = {
                Cfg: {
                    CanDrag: 1, // 행 드래그 가능
                    SearchMode: 0, // Fastload
                    MainCol: "title", // 트리 컬럼
                },
                Def: {
                    Row: {
                        CanFormula: 1
                    },
                    Col: {
                        RelWidth: 1
                    }
                },
                Cols: [
                    { Header: "No", Type: "Int", Name: "SEQ", MinWidth: 50, Align: "Center", CanEdit: 0 },
                    { Header: "", Name: "status", Extend: IB_Preset.CSTATUS},
                    { Header: "메뉴명", Type: "Text", Name: "title", MinWidth: 200, CanEdit: 1 },
                    { Header: "메뉴ID", Type: "Text", Name: "menuId", MinWidth: 150, CanEdit: 1 },
                    { Header: "아이콘", Type: "Text", Name: "icon", MinWidth: 150, CanEdit: 1 },
                    { Header: "URL", Type: "Text", Name: "url", MinWidth: 150, CanEdit: 1 },
                    { Header: "표시순서", Type: "Int", Name: "sortOrder", MinWidth: 80, CanEdit: 1 },
                    { Header: "활성화", Type: "Bool", Name: "isActive", MinWidth: 80, Align: "Center", CanEdit: 1},
                    { Header: "권한", Type: "String", Name: "requriedGroup", MinWidth: 150, Align: "Center", CanEdit: 1 },
                ],
                Events: {
                    onEndDrag : function(evt) {
                        // 최대 2단계까지만 허용
                        if(evt.torow.Level > 0 && evt.type === 2) {
                            showWarning('최대 2단계까지만 허용됩니다.');
                            return 0;
                        }
                    }
                }
            };

            menuGrid = IBSheet.create({
                id: "menu-grid",
                el: "menu-grid",
                options: gridConfig
            });
        }

        // 이벤트 리스너 설정
        function setupEventListeners() {
            document.getElementById('add-menu-btn').addEventListener('click', addMenu);
            document.getElementById('del-menu-btn').addEventListener('click', delMenu);
            document.getElementById('save-all-btn').addEventListener('click', saveAllMenus);
            document.getElementById('refresh-btn').addEventListener('click', performSearch);
            
            // 검색 필드에서 엔터키 이벤트
            document.getElementById('search-title').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });
            
            document.getElementById('search-url').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });
            
        }

        // 메뉴 데이터 로드
        async function loadMenus() {
            try {
                document.getElementById('loading').classList.remove('hidden');
                const response = await axios.get(API_BASE);
                menuGrid.loadSearchData(response.data);
            } catch (error) {
                console.error('메뉴 데이터 로드 실패:', error);
                showError('메뉴 데이터를 불러올 수 없습니다.');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }


        // 검색 수행
        async function performSearch() {
            const titleSearch = document.getElementById('search-title').value.toLowerCase().trim();
            const urlSearch = document.getElementById('search-url').value.toLowerCase().trim();
            
             try {
                const response = await axios.get(API_BASE +"/search", {
                    params: {
                        title: titleSearch,
                        url: urlSearch
                    }
                });
                menuGrid.loadSearchData(response.data);
            } catch (error) {
                console.error('메뉴 데이터 로드 실패:', error);
                showError('메뉴 데이터를 불러올 수 없습니다.');
            } finally {
            }
        }
        // 새 메뉴 추가
        function addMenu() {
            const frow = menuGrid.getFocusedRow();
            const param = {
                // 현재 포커스가 된 행 위에 신규행 추가
                next: frow,
                parent: frow.parentId? menuGrid.getRowById(frow.parentId) : null
            };
            menuGrid.addRow(param);
        }

        // 선택된 메뉴 삭제
        function delMenu() {

            const frow = menuGrid.getFocusedRow();
            const del = frow.Deleted;
            if(del) {
                // 행 삭제 해제
                menuGrid.deleteRow(menuGrid.getFocusedRow(), 0);
            }else {
                // 행 삭제
                if(frow["Level"] === 0 && frow.childNodes.length > 0) {
                    showWarning('하위 메뉴가 있는 최상위 메뉴는 삭제할 수 없습니다.');
                    return;
                }
                menuGrid.deleteRow(menuGrid.getFocusedRow());
            }
        }
        
        // 전체 메뉴 저장
        async function saveAllMenus() {
            try {
                document.getElementById('loading').classList.remove('hidden');
                
                // 그리드에서 변경된 데이터 가져오기
                const changedData = menuGrid.getSaveJson2({treeId:"menuId"});
                
                if (changedData.length === 0) {
                    showInfo('변경된 데이터가 없습니다.');
                    return;
                }
                await axios.post(`${API_BASE}`, JSON.stringify(changedData),{
                    headers: {
                        "Content-Type": `application/json`,
                    },
                });
                
                showSuccess('모든 메뉴가 성공적으로 저장되었습니다.');
                loadMenus();
            } catch (error) {
                console.error('메뉴 저장 실패:', error);
                showError('메뉴 저장에 실패했습니다.');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }


       
    </script>
</body>
</html>
