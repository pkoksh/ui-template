<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{fragments/common :: ibsheet-head}"></th:block>
    <title>공지사항 관리</title>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <div class="p-6 flex flex-col h-full">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-200">공지사항 관리</h3>
            <div class="flex items-center space-x-2">
                <button id="save-all-btn" class="bg-[#2563EB] hover:bg-[#2563EB]/80 text-white px-5 py-2.5 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md">
                    <i class='bx bx-save text-lg'></i>
                    <span class="font-medium">저장</span>
                </button>
                <button id="refresh-btn" class="bg-[#6C757D] hover:bg-[#6C757D]/80 text-white px-5 py-2.5 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md">
                    <i class='bx bx-refresh text-lg'></i>
                    <span class="font-medium">조회</span>
                </button>
                <button id="add-user-btn" class="bg-[#ADB5BD] hover:bg-[#ADB5BD]/80 text-white px-5 py-2.5 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md">
                    <i class='bx bx-plus text-lg'></i>
                    <span class="font-medium">추가</span>
                </button>
                <button id="del-user-btn" class="bg-[#ADB5BD] hover:bg-[#ADB5BD]/80 text-white px-5 py-2.5 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md">
                    <i class='bx bx-minus text-lg'></i>
                    <span class="font-medium">삭제</span>
                </button>
            </div>
        </div>

        <!-- 검색 필터 -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">내용 검색</label>
                    <input type="text" id="search-user-id" placeholder="사용자ID를 입력하세요" 
                           class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent dark:bg-gray-700 dark:text-gray-100 transition-all duration-200">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">이름 검색</label>
                    <input type="text" id="search-name" placeholder="이름을 입력하세요" 
                           class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent dark:bg-gray-700 dark:text-gray-100 transition-all duration-200">
                </div>
            </div>
        </div>

        <!-- IBSheet 그리드 영역 -->
        <div class="h-full">
            <div id="notice-grid" style="height: 100%;"></div>
        </div>

        <!-- 로딩 표시 -->
        <th:block th:replace="~{fragments/common :: loading-spinner}"></th:block>
    </div>
    <!-- 페이지별 스크립트 -->
    <script>
        let noticeGrid = null; // IBSheet 그리드 객체

        // API 기본 설정
        const API_BASE = '/api/notices';

        // 페이지 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initGrid();
            loadNotices();
            setupEventListeners();
        });

        // IBSheet 그리드 초기화
        function initGrid() {
            const gridConfig = {
                Cfg: {
                    SearchMode: 0, // Fastload
                },
                Def: {
                    Row: {
                        CanFormula: 1
                    },
                    Col: {
                        CanEdit: 0
                    }
                },
                Cols: [
                    { Header: "No", Type: "Int", Name: "seq", MinWidth: 50, Align: "Center" },
                    { Header: "상태", Name: "status", Extend: IB_Preset.CSTATUS},
                    { Header: "제목", Type: "Text", Name: "title", MinWidth: 220, RelWidth: 1 },
                    { Header: "내용", Type: "Text", Name: "content", Visible: 0 },
                    { Header: "작성자", Type: "Text", Name: "authorName", MinWidth: 80 },
                    { Header: "상단고정", Type: "Bool", Name: "pinned", MinWidth: 60 },
                    { Header: "사용여부", Type: "Bool", Name: "active", MinWidth: 60 },
                    { Header: "조회수", Type: "Int", Name: "viewCount", MinWidth: 60 },
                    { Header: "첨부파일", Type: "File", Name: "attachment", MinWidth: 120 },
                  
                    { Header: "생성일", Name: "createdAt", Extend:IB_Preset.DATETIME, MinWidth: 140, Align: "Center" },
                    { Header: "수정일", Name: "updatedAt", Extend:IB_Preset.DATETIME, MinWidth: 140, Align: "Center"    }
                ]
            };

            noticeGrid = IBSheet.create({
                id: "notice-grid",
                el: "notice-grid",
                options: gridConfig
            });
        }

        // 이벤트 리스너 설정
        function setupEventListeners() {
            document.getElementById('add-user-btn').addEventListener('click', addUser);
            document.getElementById('del-user-btn').addEventListener('click', delUser);
            document.getElementById('save-all-btn').addEventListener('click', saveAllUsers);
            document.getElementById('refresh-btn').addEventListener('click', performSearch);
            document.getElementById('reset-password-btn').addEventListener('click', resetPassword);
            
            // 검색 필드에서 엔터키 이벤트
            document.getElementById('search-user-id').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });
            
            document.getElementById('search-name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });
            
            document.getElementById('search-department').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });
            
            // 권한 필터 변경시 자동 검색
            document.getElementById('search-group').addEventListener('change', performSearch);
        }

        // 사용자 데이터 로드
        async function loadUsers() {
            try {
                document.getElementById('loading').classList.remove('hidden');
                const response = await axios.get(API_BASE);
                noticeGrid.loadSearchData(response.data);
            } catch (error) {
                console.error('사용자 데이터 로드 실패:', error);
                showError('사용자 데이터를 불러올 수 없습니다.');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // 검색 수행
        async function performSearch() {
            const userIdSearch = document.getElementById('search-user-id').value.toLowerCase().trim();
            const nameSearch = document.getElementById('search-name').value.toLowerCase().trim();
            const departmentSearch = document.getElementById('search-department').value.toLowerCase().trim();
            const groupSearch = document.getElementById('search-group').value;
            
            try {
                document.getElementById('loading').classList.remove('hidden');
                // const response = await axios.get(API_BASE + "/search", {
                //     params: {
                //         userId: userIdSearch,
                //         name: nameSearch,
                //         department: departmentSearch,
                //         groupId: groupSearch
                //     }
                // });

                const response = await apiGet(API_BASE + "/search", {
                        userId: userIdSearch,
                        name: nameSearch,
                        department: departmentSearch,
                        groupId: groupSearch
                    });
                noticeGrid.loadSearchData(response.data);
            } catch (error) {
                console.error('사용자 데이터 로드 실패:', error);
                showError('사용자 데이터를 불러올 수 없습니다.');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // 새 사용자 추가
        function addUser() {
            const newUserData = {
                userId: '',
                name: '',
                email: '',
                department: '',
                groupId: 'USER',
                isActive: true,
                createdAt: new Date().toISOString().split('T')[0],
                updatedAt: new Date().toISOString().split('T')[0]
            };
            
            noticeGrid.addRow({ data: newUserData });
        }

        // 선택된 사용자 삭제
        function delUser() {
            const frow = noticeGrid.getFocusedRow();
            if (!frow || frow.Kind === "Header") {
                showWarning('삭제할 사용자를 선택해주세요.');
                return;
            }

            const del = frow.Deleted;
            if (del) {
                // 행 삭제 해제
                noticeGrid.deleteRow(frow, 0);
                showInfo('사용자 삭제가 취소되었습니다.');
            } else {
                // 현재 로그인한 사용자인지 확인 (실제로는 서버에서 확인해야 함)
                Swal.fire({
                    title: '사용자 삭제',
                    text: `${frow.name}(${frow.userId}) 사용자를 삭제하시겠습니까?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: '삭제',
                    cancelButtonText: '취소'
                }).then((result) => {
                    if (result.isConfirmed) {
                        noticeGrid.deleteRow(frow);
                        showSuccess('사용자가 삭제 표시되었습니다.');
                    }
                });
            }
        }

        // 비밀번호 초기화
        async function resetPassword() {
            const frow = noticeGrid.getFocusedRow();
            if (!frow || frow.Kind === "Header") {
                showWarning('비밀번호를 초기화할 사용자를 선택해주세요.');
                return;
            }

            if (frow.Added) {
                showWarning('저장되지 않은 신규 사용자입니다. 먼저 저장해주세요.');
                return;
            }

            Swal.fire({
                title: '비밀번호 초기화',
                text: `${frow.name}(${frow.userId}) 사용자의 비밀번호를 초기화하시겠습니까?\n초기화된 비밀번호는 "user123" 입니다.`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: '초기화',
                cancelButtonText: '취소'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        document.getElementById('loading').classList.remove('hidden');
                        await axios.post(`${API_BASE}/${frow.userId}/reset-password`);
                        showSuccess('비밀번호가 성공적으로 초기화되었습니다.');
                    } catch (error) {
                        console.error('비밀번호 초기화 실패:', error);
                        showError('비밀번호 초기화에 실패했습니다.');
                    } finally {
                        document.getElementById('loading').classList.add('hidden');
                    }
                }
            });
        }
        
        // 전체 사용자 저장
        async function saveAllUsers() {
           saveAllData(noticeGrid, API_BASE, loadUsers)
        }

        // 페이지 종료시 호출 (부모 프레임에서 호출)
        function onPageClose() {
            // 변경사항이 있는지 확인하고 경고
            if (noticeGrid && noticeGrid.getChangedData().length > 0) {
                return '저장하지 않은 변경사항이 있습니다. 정말 페이지를 닫으시겠습니까?';
            }
        }
    </script>
</body>
</html>
