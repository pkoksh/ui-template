<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{fragments/common :: ibsheet-head}"></th:block>
    <title>그룹 관리</title>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <div class="p-6 flex flex-col h-full">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-200">그룹 관리</h3>
            <div class="flex items-center space-x-2">
                <button id="save-all-btn" class="bg-[#2563EB] hover:bg-[#2563EB]/80 text-white px-5 py-2.5 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md">
                    <i class='bx bx-save text-lg'></i>
                    <span class="font-medium">저장</span>
                </button>
                <button id="refresh-btn" class="bg-[#6C757D] hover:bg-[#6C757D]/80 text-white px-5 py-2.5 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md">
                    <i class='bx bx-refresh text-lg'></i>
                    <span class="font-medium">조회</span>
                </button>
                <button id="add-group-btn" class="bg-[#ADB5BD] hover:bg-[#ADB5BD]/80 text-white px-5 py-2.5 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md">
                    <i class='bx bx-plus text-lg'></i>
                    <span class="font-medium">그룹 추가</span>
                </button>
                <!--
                <button id="del-group-btn" class="bg-[#ADB5BD] hover:bg-[#ADB5BD]/80 text-white px-5 py-2.5 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md">
                    <i class='bx bx-minus text-lg'></i>
                    <span class="font-medium">그룹 삭제</span>
                </button>
                
                <button id="permission-btn" class="bg-[#17A2B8] hover:bg-[#17A2B8]/80 text-white px-5 py-2.5 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md">
                    <i class='bx bx-shield text-lg'></i>
                    <span class="font-medium">권한 설정</span>
                </button>
                -->
            </div>
        </div>

        <!-- 검색 필터 -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">그룹명 검색</label>
                    <input type="text" id="search-group-name" placeholder="그룹명을 입력하세요" 
                           class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent dark:bg-gray-700 dark:text-gray-100 transition-all duration-200">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">권한 레벨</label>
                    <select id="search-level" class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent dark:bg-gray-700 dark:text-gray-100 transition-all duration-200">
                        <option value="">전체</option>
                        <option value="10">슈퍼관리자 (10)</option>
                        <option value="8">관리자 (8)</option>
                        <option value="6">매니저 (6)</option>
                        <option value="4">팀장 (4)</option>
                        <option value="1">일반사용자 (1)</option>
                        <option value="0">게스트 (0)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">활성화 상태</label>
                    <select id="search-active" class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent dark:bg-gray-700 dark:text-gray-100 transition-all duration-200">
                        <option value="">전체</option>
                        <option value="true">활성화</option>
                        <option value="false">비활성화</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- IBSheet 그리드 영역 -->
        <div class="flex-1">
            <div id="group-grid" style="height: 100%;"></div>
        </div>

        <!-- 로딩 표시 -->
        <th:block th:replace="~{fragments/common :: loading-spinner}"></th:block>
    </div>

    <!-- 권한 설정 모달 -->
    <div id="permission-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-5xl max-h-[90vh] overflow-hidden">
                <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
                    <h4 class="text-xl font-semibold text-gray-800 dark:text-gray-200">
                        <span id="modal-group-name">그룹명</span>(<span id="modal-group-id">그룹ID</span>) - 메뉴 권한 설정
                    </h4>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class='bx bx-x text-2xl'></i>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto max-h-[70vh]">
                    <div class="mb-4">
                        <div class="flex items-center space-x-4 text-sm text-gray-600 dark:text-gray-400">
                            <div class="flex items-center space-x-1">
                                <i class='bx bx-show text-blue-500'></i>
                                <span>조회</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <i class='bx bx-edit text-green-500'></i>
                                <span>편집</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <i class='bx bx-trash text-red-500'></i>
                                <span>삭제</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <i class='bx bx-cog text-purple-500'></i>
                                <span>관리</span>
                            </div>
                        </div>
                    </div>
                    <div id="permission-grid" style="height: 400px;"></div>
                </div>
                <div class="flex justify-end space-x-3 p-6 border-t border-gray-200 dark:border-gray-700">
                    <button id="cancel-permission-btn" class="px-6 py-2.5 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200">
                        취소
                    </button>
                    <button id="save-permission-btn" class="px-6 py-2.5 bg-[#2563EB] hover:bg-[#2563EB]/80 text-white rounded-xl transition-all duration-200">
                        권한 저장
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 페이지별 스크립트 -->
    <script>
        let groupGrid = null; // IBSheet 그리드 객체
        let permissionGrid = null; // 권한 설정 그리드 객체
        let currentGroupId = null; // 현재 선택된 그룹 ID

        // API 기본 설정
        const API_BASE = '/api/groups';
        const MENU_API_BASE = '/api/menus';

        // 페이지 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initGrid();
            loadGroups();
            setupEventListeners();
        });

        // IBSheet 그리드 초기화
        function initGrid() {
            const gridConfig = {
                Cfg: {
                    SearchMode: 0, // Fastload
                },
                Def: {
                    Row: {
                        CanFormula: 1
                    },
                    Col: {
                        RelWidth: 1
                    }
                },
                Cols: [
                    { Header: "No", Type: "Int", Name: "SEQ", MinWidth: 50, Align: "Center", CanEdit: 0 },
                    { Header: "상태", Name: "status", Extend: IB_Preset.CSTATUS},
                    { Header: "그룹ID", Type: "Text", Name: "groupId", MinWidth: 120, AddEdit:1, ChangeEdit:0, Required: 1},
                    { Header: "그룹명", Type: "Text", Name: "groupName", MinWidth: 150, CanEdit: 1, Required: 1, TextStyle: 5, Cursor:"pointer" },
                    { Header: "설명", Type: "Text", Name: "description", MinWidth: 200, CanEdit: 1 },
                    { Header: "권한레벨", Type: "Int", Name: "level", MinWidth: 100, Align: "Center", CanEdit: 1, Required: 1 },
                    { Header: "활성화", Type: "Bool", Name: "isActive", MinWidth: 80, Align: "Center", CanEdit: 1 }
                ],
                Events: {
                  // 그룹ID, 그룹명 호출시 권한 설정 모달 표시
                  onAfterClick: function(evt) {
                    if(evt.row.Kind === "Data") {
                      if( evt.col == "groupName") {
                        showPermissionModal();
                      }
                    }
                  }
                }
            };

            groupGrid = IBSheet.create({
                id: "group-grid",
                el: "group-grid",
                options: gridConfig
            });

            // 권한 설정 그리드 초기화
            initPermissionGrid();
        }

        // 권한 설정 그리드 초기화
        function initPermissionGrid() {
            const permissionGridConfig = {
                Cfg: {
                    SearchMode: 0,
                    CanDrag: 0,
                    MainCol: "title",
                    HeaderCheck: 1
                },
                Def: {
                    Row: {
                        CanFormula: 1,
                        CalcOrder:"status,canReadType,canReadCanEdit,canWriteType,canWriteCanEdit,canDeleteType,canDeleteCanEdit,canAdminType,canAdminCanEdit"
                    },
                    Col: {
                        RelWidth: 1
                    }
                },
                Cols: [
                    { Header: "No", Type: "Int", Name: "SEQ", MinWidth: 50, Align: "Center", CanEdit: 0 },
                    { Header: "상태", Name:"status", Extend: IB_Preset.CSTATUS, MinWidth: 50},
                    { Header: "메뉴명", Type: "Text", Name: "title", MinWidth: 200, CanEdit: 0 },
                    { Header: "URL", Type: "Text", Name: "url", MinWidth: 150, CanEdit: 0 },
                    { Header: "조회", Type: "Bool", Name: "canRead", MinWidth: 80, Align: "Center", CanEditFormula: "Row.url==''?0:1", TypeFormula: "Row.url==''?'Text':'Bool'"},
                    { Header: "편집", Type: "Bool", Name: "canWrite", MinWidth: 80, Align: "Center", CanEditFormula: "Row.url==''?0:1", TypeFormula: "Row.url==''?'Text':'Bool'"},
                    { Header: "삭제", Type: "Bool", Name: "canDelete", MinWidth: 80, Align: "Center", CanEditFormula: "Row.url==''?0:1", TypeFormula: "Row.url==''?'Text':'Bool'"},
                    { Header: "관리", Type: "Bool", Name: "canAdmin", MinWidth: 80, Align: "Center", CanEditFormula: "Row.url==''?0:1", TypeFormula: "Row.url==''?'Text':'Bool'"},
                    { Header: "메뉴ID", Type: "Text", Name: "menuId", Visible: 0 },
                ]
            };

            permissionGrid = IBSheet.create({
                id: "permission-grid",
                el: "permission-grid",
                options: permissionGridConfig
            });
        }

        // 이벤트 리스너 설정
        function setupEventListeners() {
            document.getElementById('add-group-btn').addEventListener('click', addGroup);
            // document.getElementById('del-group-btn').addEventListener('click', delGroup);
            document.getElementById('save-all-btn').addEventListener('click', saveAllGroups);
            document.getElementById('refresh-btn').addEventListener('click', performSearch);
            // document.getElementById('permission-btn').addEventListener('click', showPermissionModal);
            
            // 모달 관련 이벤트
            document.getElementById('close-modal-btn').addEventListener('click', closePermissionModal);
            document.getElementById('cancel-permission-btn').addEventListener('click', closePermissionModal);
            document.getElementById('save-permission-btn').addEventListener('click', savePermissions);
            
            // 검색 필드에서 엔터키 이벤트
            document.getElementById('search-group-name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });
            
            // 필터 변경시 자동 검색
            document.getElementById('search-level').addEventListener('change', performSearch);
            document.getElementById('search-active').addEventListener('change', performSearch);
        }

        // 그룹 데이터 로드
        async function loadGroups() {
            try {
                document.getElementById('loading').classList.remove('hidden');
                const response = await axios.get(API_BASE);
                groupGrid.loadSearchData(response.data);
            } catch (error) {
                console.error('그룹 데이터 로드 실패:', error);
                showError('그룹 데이터를 불러올 수 없습니다.');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // 검색 수행
        async function performSearch() {
            const groupNameSearch = document.getElementById('search-group-name').value.toLowerCase().trim();
            const levelSearch = document.getElementById('search-level').value;
            const activeSearch = document.getElementById('search-active').value;
            
            try {
                document.getElementById('loading').classList.remove('hidden');
                const response = await axios.get(API_BASE + "/search", {
                    params: {
                        groupName: groupNameSearch,
                        level: levelSearch,
                        isActive: activeSearch
                    }
                });
                groupGrid.loadSearchData(response.data);
            } catch (error) {
                console.error('그룹 데이터 로드 실패:', error);
                showError('그룹 데이터를 불러올 수 없습니다.');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // 새 그룹 추가
        function addGroup() {
            const newGroupData = {
                groupId: '',
                groupName: '',
                description: '',
                level: 1,
                isActive: 1
            };
            
            groupGrid.addRow({ init: newGroupData });
        }

        // 선택된 그룹 삭제
        // function delGroup() {
          // 일단 그룹 삭제는 안하는 거로 하자.
            // const frow = groupGrid.getFocusedRow();
            // if (!frow || frow.Kind === "Header") {
            //     showWarning('삭제할 그룹을 선택해주세요.');
            //     return;
            // }

            // const del = frow.Deleted;
            // if (del) {
            //     // 행 삭제 해제
            //     groupGrid.deleteRow(frow, 0);
            //     showInfo('그룹 삭제가 취소되었습니다.');
            // } else {
            //     Swal.fire({
            //         title: '그룹 삭제',
            //         text: `${frow.groupName}(${frow.groupId}) 그룹을 삭제하시겠습니까?`,
            //         icon: 'warning',
            //         showCancelButton: true,
            //         confirmButtonColor: '#d33',
            //         cancelButtonColor: '#3085d6',
            //         confirmButtonText: '삭제',
            //         cancelButtonText: '취소'
            //     }).then((result) => {
            //         if (result.isConfirmed) {
            //             groupGrid.deleteRow(frow);
            //             showSuccess('그룹이 삭제 표시되었습니다.');
            //         }
            //     });
            // }
        // }

        // 권한 설정 모달 표시
        async function showPermissionModal() {
            const frow = groupGrid.getFocusedRow();
            if (!frow || frow.Kind === "Header") {
                showWarning('권한을 설정할 그룹을 선택해주세요.');
                return;
            }

            if (frow.Added) {
                showWarning('저장되지 않은 신규 그룹입니다. 먼저 저장해주세요.');
                return;
            }

            currentGroupId = groupGrid.getValue(frow,"groupId");
            document.getElementById('modal-group-name').textContent = groupGrid.getValue(frow,"groupName");
            document.getElementById('modal-group-id').textContent = currentGroupId;
            
            try {
                // 메뉴 목록과 현재 그룹의 권한 정보를 가져옵니다
                const [menusResponse, permissionsResponse] = await Promise.all([
                    axios.get(MENU_API_BASE),
                    axios.get(`${API_BASE}/${currentGroupId}/permissions`)
                ]);

                const menus = menusResponse.data;
                const permissions = permissionsResponse.data;

                // 메뉴 데이터에 권한 정보 매핑
                const permissionData = menus.map(menu => {

                    const Items = [];
                    if(menu.Items && menu.Items.length) {
                        menu.Items.forEach(subMenu => {
                            const subPermission = permissions.data.find(p => p.menuId === subMenu.menuId) || {
                                canRead: '',
                                canWrite: '',
                                canDelete: '',
                                canAdmin: ''
                            };
                            Items.push({
                                menuId: subMenu.menuId,
                                title: subMenu.title,
                                url: subMenu.url || '',
                                canRead: subPermission.canRead?1:'',
                                canWrite: subPermission.canWrite?1:'',
                                canDelete: subPermission.canDelete?1:'',
                                canAdmin: subPermission.canAdmin?1:'',
                                status: 'Unchanged'
                            });
                        });
                    }


                    const permission = permissions.data.find(p => p.menuId === menu.menuId) || {
                        canRead: '',
                        canWrite: '',
                        canDelete: '',
                        canAdmin: ''
                    };

                    return {
                        menuId: menu.menuId,
                        title: menu.title,
                        url: menu.url || '',
                        canRead: permission.canRead?1:'',
                        canWrite: permission.canWrite?1:'',
                        canDelete: permission.canDelete?1:'',
                        canAdmin: permission.canAdmin?1:'',
                        Items: Items
                    };
                });

                permissionGrid.loadSearchData(permissionData);
                document.getElementById('permission-modal').classList.remove('hidden');
            } catch (error) {
                console.error('권한 정보 로드 실패:', error);
                showError('권한 정보를 불러올 수 없습니다.');
            }
        }

        // 권한 설정 모달 닫기
        function closePermissionModal() {
            document.getElementById('permission-modal').classList.add('hidden');
            currentGroupId = null;
        }

        // 권한 저장
        async function savePermissions() {
            try {
                document.getElementById('loading').classList.remove('hidden');
                
                // 그리드에서 권한 데이터 가져오기
                const permissionData = permissionGrid.getSaveJson2();
                
                await axios.post(`${API_BASE}/${currentGroupId}/permissions`, 
                    JSON.stringify(permissionData), {
                    headers: {
                        "Content-Type": `application/json`,
                    },
                });
                
                showSuccess('권한이 성공적으로 저장되었습니다.');
                closePermissionModal();
            } catch (error) {
                console.error('권한 저장 실패:', error);
                showError('권한 저장에 실패했습니다.');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }
        
        // 전체 그룹 저장
        async function saveAllGroups() {
            try {
                document.getElementById('loading').classList.remove('hidden');
                
                // 그리드에서 변경된 데이터 가져오기
                const changedData = groupGrid.getSaveJson2();
                
                if (changedData.length === 0) {
                    showInfo('변경된 데이터가 없습니다.');
                    return;
                }
            
    
                await axios.post(`${API_BASE}`, JSON.stringify(changedData), {
                    headers: {
                        "Content-Type": `application/json`,
                    },
                });
                
                showSuccess('모든 그룹 정보가 성공적으로 저장되었습니다.');
                loadGroups();
            } catch (error) {
                console.error('그룹 저장 실패:', error);
                if (error.response && error.response.data && error.response.data.message) {
                    showError(`그룹 저장에 실패했습니다: ${error.response.data.message}`);
                } else {
                    showError('그룹 저장에 실패했습니다.');
                }
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // 페이지 종료시 호출 (부모 프레임에서 호출)
        function onPageClose() {
            // 변경사항이 있는지 확인하고 경고
            if (groupGrid && groupGrid.getChangedData().length > 0) {
                return '저장하지 않은 변경사항이 있습니다. 정말 페이지를 닫으시겠습니까?';
            }
        }
    </script>
</body>
</html>
