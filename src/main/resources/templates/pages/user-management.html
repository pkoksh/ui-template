<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{fragments/common :: ibsheet-head}"></th:block>
    <title>사용자 관리</title>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <div class="p-6 flex flex-col h-full">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-200">사용자 관리</h3>
            <div class="flex items-center space-x-2">
                <button id="save-all-btn" class="bg-[#2563EB] hover:bg-[#2563EB]/80 text-white px-5 py-2.5 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md">
                    <i class='bx bx-save text-lg'></i>
                    <span class="font-medium">저장</span>
                </button>
                <button id="refresh-btn" class="bg-[#6C757D] hover:bg-[#6C757D]/80 text-white px-5 py-2.5 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md">
                    <i class='bx bx-refresh text-lg'></i>
                    <span class="font-medium">조회</span>
                </button>
                <button id="add-user-btn" class="bg-[#ADB5BD] hover:bg-[#ADB5BD]/80 text-white px-5 py-2.5 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md">
                    <i class='bx bx-plus text-lg'></i>
                    <span class="font-medium">추가</span>
                </button>
                <button id="del-user-btn" class="bg-[#ADB5BD] hover:bg-[#ADB5BD]/80 text-white px-5 py-2.5 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md">
                    <i class='bx bx-minus text-lg'></i>
                    <span class="font-medium">삭제</span>
                </button>
                <button id="reset-password-btn" class="bg-[#FFA500] hover:bg-[#FFA500]/80 text-white px-5 py-2.5 rounded-xl flex items-center space-x-2 shadow-sm transition-all duration-200 hover:shadow-md">
                    <i class='bx bx-reset text-lg'></i>
                    <span class="font-medium">비밀번호 초기화</span>
                </button>
            </div>
        </div>

        <!-- 검색 필터 -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">사용자ID 검색</label>
                    <input type="text" id="search-user-id" placeholder="사용자ID를 입력하세요" 
                           class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent dark:bg-gray-700 dark:text-gray-100 transition-all duration-200">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">이름 검색</label>
                    <input type="text" id="search-name" placeholder="이름을 입력하세요" 
                           class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent dark:bg-gray-700 dark:text-gray-100 transition-all duration-200">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">부서 검색</label>
                    <input type="text" id="search-department" placeholder="부서를 입력하세요" 
                           class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent dark:bg-gray-700 dark:text-gray-100 transition-all duration-200">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">권한 필터</label>
                    <select id="search-group" class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent dark:bg-gray-700 dark:text-gray-100 transition-all duration-200">
                        <option value="">전체</option>
                        <option value="ADMIN">관리자</option>
                        <option value="MANAGER">매니저</option>
                        <option value="USER">사용자</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- IBSheet 그리드 영역 -->
        <div class="h-full">
            <div id="user-grid" style="height: 100%;"></div>
        </div>

        <!-- 로딩 표시 -->
        <th:block th:replace="~{fragments/common :: loading-spinner}"></th:block>
    </div>
    <script th:inline="javascript">
        /*<![CDATA[*/
        // Thymeleaf에서 groupEnum 값을 JavaScript 변수로 전달
        const groupEnum = /*[[${groupEnum}]]*/ {};
        
        console.log('서버에서 전달받은 groupEnum:', groupEnum);
        // 결과: { code: ["ADMIN", "MANAGER", "USER"], text: ["관리자", "매니저", "사용자"] }
        /*]]>*/
    </script>
    <!-- 페이지별 스크립트 -->
    <script>
        let userGrid = null; // IBSheet 그리드 객체

        // API 기본 설정
        const API_BASE = '/api/users';

        // 페이지 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initGrid();
            loadUsers();
            setupEventListeners();
        });

        // IBSheet 그리드 초기화
        function initGrid() {
            const gridConfig = {
                Cfg: {
                    SearchMode: 0, // Fastload
                },
                Def: {
                    Row: {
                        CanFormula: 1
                    },
                    Col: {
                        RelWidth: 1
                    }
                },
                Cols: [
                    { Header: "No", Type: "Int", Name: "SEQ", MinWidth: 50, Align: "Center", CanEdit: 0 },
                    { Header: "상태", Name: "status", Extend: IB_Preset.CSTATUS},
                    { Header: "사용자ID", Type: "Text", Name: "userId", MinWidth: 120, CanEdit: 1, Required: 1 },
                    { Header: "이름", Type: "Text", Name: "name", MinWidth: 120, CanEdit: 1, Required: 1 },
                    { Header: "이메일", Type: "Email", Name: "email", MinWidth: 200, CanEdit: 1 },
                    { Header: "부서", Type: "Text", Name: "department", MinWidth: 150, CanEdit: 1 },
                    { Header: "권한", Type: "Enum", Name: "groupId", MinWidth: 100, Align: "Center", CanEdit: 1, Required: 1, ...getEnumInfo(groupEnum)},
                    { Header: "활성화", Type: "Bool", Name: "active", MinWidth: 80, Align: "Center", CanEdit: 1 },
                    { Header: "생성일", Name: "createAt", CanEdit: 0, Extend: IB_Preset.YMD}
                ]
            };

            userGrid = IBSheet.create({
                id: "user-grid",
                el: "user-grid",
                options: gridConfig
            });
        }

        // 이벤트 리스너 설정
        function setupEventListeners() {
            document.getElementById('add-user-btn').addEventListener('click', addUser);
            document.getElementById('del-user-btn').addEventListener('click', delUser);
            document.getElementById('save-all-btn').addEventListener('click', saveAllUsers);
            document.getElementById('refresh-btn').addEventListener('click', performSearch);
            document.getElementById('reset-password-btn').addEventListener('click', resetPassword);
            
            // 검색 필드에서 엔터키 이벤트
            document.getElementById('search-user-id').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });
            
            document.getElementById('search-name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });
            
            document.getElementById('search-department').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });
            
            // 권한 필터 변경시 자동 검색
            document.getElementById('search-group').addEventListener('change', performSearch);
        }

        // 사용자 데이터 로드
        async function loadUsers() {
            try {
                document.getElementById('loading').classList.remove('hidden');
                const response = await axios.get(API_BASE);
                userGrid.loadSearchData(response.data);
            } catch (error) {
                console.error('사용자 데이터 로드 실패:', error);
                showError('사용자 데이터를 불러올 수 없습니다.');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // 검색 수행
        async function performSearch() {
            const userIdSearch = document.getElementById('search-user-id').value.toLowerCase().trim();
            const nameSearch = document.getElementById('search-name').value.toLowerCase().trim();
            const departmentSearch = document.getElementById('search-department').value.toLowerCase().trim();
            const groupSearch = document.getElementById('search-group').value;
            
            try {
                document.getElementById('loading').classList.remove('hidden');
                const response = await axios.get(API_BASE + "/search", {
                    params: {
                        userId: userIdSearch,
                        name: nameSearch,
                        department: departmentSearch,
                        groupId: groupSearch
                    }
                });
                userGrid.loadSearchData(response.data);
            } catch (error) {
                console.error('사용자 데이터 로드 실패:', error);
                showError('사용자 데이터를 불러올 수 없습니다.');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // 새 사용자 추가
        function addUser() {
            const newUserData = {
                userId: '',
                name: '',
                email: '',
                department: '',
                groupId: 'USER',
                isActive: true,
                createdAt: new Date().toISOString().split('T')[0],
                updatedAt: new Date().toISOString().split('T')[0]
            };
            
            userGrid.addRow({ data: newUserData });
        }

        // 선택된 사용자 삭제
        function delUser() {
            const frow = userGrid.getFocusedRow();
            if (!frow || frow.Kind === "Header") {
                showWarning('삭제할 사용자를 선택해주세요.');
                return;
            }

            const del = frow.Deleted;
            if (del) {
                // 행 삭제 해제
                userGrid.deleteRow(frow, 0);
                showInfo('사용자 삭제가 취소되었습니다.');
            } else {
                // 현재 로그인한 사용자인지 확인 (실제로는 서버에서 확인해야 함)
                Swal.fire({
                    title: '사용자 삭제',
                    text: `${frow.name}(${frow.userId}) 사용자를 삭제하시겠습니까?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: '삭제',
                    cancelButtonText: '취소'
                }).then((result) => {
                    if (result.isConfirmed) {
                        userGrid.deleteRow(frow);
                        showSuccess('사용자가 삭제 표시되었습니다.');
                    }
                });
            }
        }

        // 비밀번호 초기화
        async function resetPassword() {
            const frow = userGrid.getFocusedRow();
            if (!frow || frow.Kind === "Header") {
                showWarning('비밀번호를 초기화할 사용자를 선택해주세요.');
                return;
            }

            if (frow.Added) {
                showWarning('저장되지 않은 신규 사용자입니다. 먼저 저장해주세요.');
                return;
            }

            Swal.fire({
                title: '비밀번호 초기화',
                text: `${frow.name}(${frow.userId}) 사용자의 비밀번호를 초기화하시겠습니까?\n초기화된 비밀번호는 "user123" 입니다.`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: '초기화',
                cancelButtonText: '취소'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        document.getElementById('loading').classList.remove('hidden');
                        await axios.post(`${API_BASE}/${frow.userId}/reset-password`);
                        showSuccess('비밀번호가 성공적으로 초기화되었습니다.');
                    } catch (error) {
                        console.error('비밀번호 초기화 실패:', error);
                        showError('비밀번호 초기화에 실패했습니다.');
                    } finally {
                        document.getElementById('loading').classList.add('hidden');
                    }
                }
            });
        }
        
        // 전체 사용자 저장
        async function saveAllUsers() {
            try {
                document.getElementById('loading').classList.remove('hidden');
                
                // 그리드에서 변경된 데이터 가져오기
                const changedData = userGrid.getSaveJson2();
                
                if (changedData.length === 0) {
                    showInfo('변경된 데이터가 없습니다.');
                    return;
                }

                // 필수 필드 검증
                let hasError = false;
                changedData.forEach((user, index) => {
                    if (!user.userId || user.userId.trim() === '') {
                        showError(`${index + 1}번째 행: 사용자ID는 필수입니다.`);
                        hasError = true;
                        return;
                    }
                    if (!user.name || user.name.trim() === '') {
                        showError(`${index + 1}번째 행: 이름은 필수입니다.`);
                        hasError = true;
                        return;
                    }
                    if (!user.groupId || user.groupId.trim() === '') {
                        showError(`${index + 1}번째 행: 권한은 필수입니다.`);
                        hasError = true;
                        return;
                    }
                });

                if (hasError) {
                    return;
                }
                
                await axios.post(`${API_BASE}`, JSON.stringify(changedData), {
                    headers: {
                        "Content-Type": `application/json`,
                    },
                });
                
                showSuccess('모든 사용자 정보가 성공적으로 저장되었습니다.');
                loadUsers();
            } catch (error) {
                console.error('사용자 저장 실패:', error);
                if (error.response && error.response.data && error.response.data.message) {
                    showError(`사용자 저장에 실패했습니다: ${error.response.data.message}`);
                } else {
                    showError('사용자 저장에 실패했습니다.');
                }
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // 페이지 종료시 호출 (부모 프레임에서 호출)
        function onPageClose() {
            // 변경사항이 있는지 확인하고 경고
            if (userGrid && userGrid.getChangedData().length > 0) {
                return '저장하지 않은 변경사항이 있습니다. 정말 페이지를 닫으시겠습니까?';
            }
        }
    </script>
</body>
</html>
